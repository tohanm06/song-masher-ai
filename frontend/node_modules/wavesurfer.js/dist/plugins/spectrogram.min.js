!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).WaveSurfer=e.WaveSurfer||{},e.WaveSurfer.Spectrogram=t())}(this,(function(){"use strict";class e{constructor(){this.listeners={},this.on=this.addEventListener,this.un=this.removeEventListener}addEventListener(e,t,s){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t),null==s?void 0:s.once){const s=()=>{this.removeEventListener(e,s),this.removeEventListener(e,t)};return this.addEventListener(e,s),s}return()=>this.removeEventListener(e,t)}removeEventListener(e,t){var s;null===(s=this.listeners[e])||void 0===s||s.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>e(...t)))}}class t extends e{constructor(e){super(),this.subscriptions=[],this.options=e}onInit(){}init(e){this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e()))}}function s(e,t,s,i){switch(this.bufferSize=e,this.sampleRate=t,this.bandwidth=2/e*(t/2),this.sinTable=new Float32Array(e),this.cosTable=new Float32Array(e),this.windowValues=new Float32Array(e),this.reverseTable=new Uint32Array(e),this.peakBand=0,this.peak=0,s){case"bartlett":for(a=0;a<e;a++)this.windowValues[a]=2/(e-1)*((e-1)/2-Math.abs(a-(e-1)/2));break;case"bartlettHann":for(a=0;a<e;a++)this.windowValues[a]=.62-.48*Math.abs(a/(e-1)-.5)-.38*Math.cos(2*Math.PI*a/(e-1));break;case"blackman":for(i=i||.16,a=0;a<e;a++)this.windowValues[a]=(1-i)/2-.5*Math.cos(2*Math.PI*a/(e-1))+i/2*Math.cos(4*Math.PI*a/(e-1));break;case"cosine":for(a=0;a<e;a++)this.windowValues[a]=Math.cos(Math.PI*a/(e-1)-Math.PI/2);break;case"gauss":for(i=i||.25,a=0;a<e;a++)this.windowValues[a]=Math.pow(Math.E,-.5*Math.pow((a-(e-1)/2)/(i*(e-1)/2),2));break;case"hamming":for(a=0;a<e;a++)this.windowValues[a]=.54-.46*Math.cos(2*Math.PI*a/(e-1));break;case"hann":case void 0:for(a=0;a<e;a++)this.windowValues[a]=.5*(1-Math.cos(2*Math.PI*a/(e-1)));break;case"lanczoz":for(a=0;a<e;a++)this.windowValues[a]=Math.sin(Math.PI*(2*a/(e-1)-1))/(Math.PI*(2*a/(e-1)-1));break;case"rectangular":for(a=0;a<e;a++)this.windowValues[a]=1;break;case"triangular":for(a=0;a<e;a++)this.windowValues[a]=2/e*(e/2-Math.abs(a-(e-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var a,r=1,n=e>>1;r<e;){for(a=0;a<r;a++)this.reverseTable[a+r]=this.reverseTable[a]+n;r<<=1,n>>=1}for(a=0;a<e;a++)this.sinTable[a]=Math.sin(-Math.PI/a),this.cosTable[a]=Math.cos(-Math.PI/a);this.calculateSpectrum=function(e){var t,s,i,a=this.bufferSize,r=this.cosTable,n=this.sinTable,h=this.reverseTable,o=new Float32Array(a),l=new Float32Array(a),c=2/this.bufferSize,f=Math.sqrt,u=new Float32Array(a/2),p=Math.floor(Math.log(a)/Math.LN2);if(Math.pow(2,p)!==a)throw"Invalid buffer size, must be a power of 2.";if(a!==e.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+a+" Buffer Size: "+e.length;for(var d,w,v,M,b,g,m,y,x=1,S=0;S<a;S++)o[S]=e[h[S]]*this.windowValues[h[S]],l[S]=0;for(;x<a;){d=r[x],w=n[x],v=1,M=0;for(var k=0;k<x;k++){for(S=k;S<a;)g=v*o[b=S+x]-M*l[b],m=v*l[b]+M*o[b],o[b]=o[S]-g,l[b]=l[S]-m,o[S]+=g,l[S]+=m,S+=x<<1;v=(y=v)*d-M*w,M=y*w+M*d}x<<=1}S=0;for(var q=a/2;S<q;S++)(i=c*f((t=o[S])*t+(s=l[S])*s))>this.peak&&(this.peakBand=S,this.peak=i),u[S]=i;return u}}class i extends t{static create(e){return new i(e||{})}constructor(e){if(super(e),this.utils={style:(e,t)=>Object.assign(e.style,t)},this.drawSpectrogram=e=>{isNaN(e[0][0])||(e=[e]),this.wrapper.style.height=this.height*e.length+"px",this.width=this.wavesurfer.getWrapper().offsetWidth,this.canvas.width=this.width,this.canvas.height=this.height*e.length;const t=this.spectrCc,s=this.height,i=this.width,a=this.buffer.sampleRate/2,r=this.frequencyMin,n=this.frequencyMax;if(t){for(let h=0;h<e.length;h++){const o=this.resample(e[h]),l=new ImageData(i,s);for(let e=0;e<o.length;e++)for(let t=0;t<o[e].length;t++){const a=this.colorMap[o[e][t]],r=4*((s-t)*i+e);l.data[r]=255*a[0],l.data[r+1]=255*a[1],l.data[r+2]=255*a[2],l.data[r+3]=255*a[3]}createImageBitmap(l).then((e=>{t.drawImage(e,0,s*(1-n/a),i,s*(n-r)/a,0,s*h,i,s)}))}this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",e.length),this.emit("ready")}},this.frequenciesDataUrl=e.frequenciesDataUrl,this.container="string"==typeof e.container?document.querySelector(e.container):e.container,e.colorMap){if(e.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let t=0;t<e.colorMap.length;t++){if(4!==e.colorMap[t].length)throw new Error("ColorMap entries must contain 4 values")}this.colorMap=e.colorMap}else{this.colorMap=[];for(let e=0;e<256;e++){const t=(255-e)/256;this.colorMap.push([t,t,t,1])}}this.fftSamples=e.fftSamples||512,this.height=e.height||this.fftSamples/2,this.noverlap=e.noverlap,this.windowFunc=e.windowFunc,this.alpha=e.alpha,this.frequencyMin=e.frequencyMin||0,this.frequencyMax=e.frequencyMax||0,this.createWrapper(),this.createCanvas()}onInit(){this.container=this.container||this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&this.utils.style(this.wrapper,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.render())))}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.wavesurfer.un("redraw",this._onRender),this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),super.destroy()}createWrapper(){if(this.wrapper=document.createElement("div"),this.utils.style(this.wrapper,{display:"block",position:"relative",userSelect:"none"}),this.options.labels){const e=document.createElement("canvas");e.setAttribute("part","spec-labels"),this.utils.style(e,{position:"absolute",zIndex:9,width:"55px",height:"100%"}),this.wrapper.appendChild(e),this.labelsEl=e}this.wrapper.addEventListener("click",this._onWrapperClick)}_wrapperClickHandler(e){e.preventDefault();const t="offsetX"in e?e.offsetX:e.layerX;this.emit("click",t/this.width||0)}createCanvas(){const e=document.createElement("canvas");this.wrapper.appendChild(e),this.spectrCc=e.getContext("2d"),this.utils.style(e,{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}),this.canvas=e}render(){var e;this.frequenciesDataUrl?this.loadFrequenciesData(this.frequenciesDataUrl):this.drawSpectrogram(this.getFrequencies(null===(e=this.wavesurfer)||void 0===e?void 0:e.getDecodedData()))}getFrequencies(e){var t,i;const a=this.fftSamples,r=(null!==(t=this.options.splitChannels)&&void 0!==t?t:null===(i=this.wavesurfer)||void 0===i?void 0:i.options.splitChannels)?e.numberOfChannels:1;if(this.frequencyMax=this.frequencyMax||e.sampleRate/2,!e)return;this.buffer=e;const n=e.sampleRate,h=[];let o=this.noverlap;if(!o){const t=e.length/this.canvas.width;o=Math.max(0,Math.round(a-t))}const l=new s(a,n,this.windowFunc,this.alpha);for(let t=0;t<r;t++){const s=e.getChannelData(t),i=[];let r=0;for(;r+a<s.length;){const e=s.slice(r,r+a),t=l.calculateSpectrum(e),n=new Uint8Array(a/2);for(let e=0;e<a/2;e++)n[e]=Math.max(-255,45*Math.log10(t[e]));i.push(n),r+=a-o}h.push(i)}return h}loadFrequenciesData(e){return fetch(e).then((e=>e.json())).then(this.drawSpectrogram)}freqType(e){return e>=1e3?(e/1e3).toFixed(1):Math.round(e)}unitType(e){return e>=1e3?"KHz":"Hz"}loadLabels(e,t,s,i,a,r,n,h,o){e=e||"rgba(68,68,68,0)",t=t||"12px",s=s||"12px",i=i||"Helvetica",a=a||"#fff",r=r||"#fff",n=n||"center";const l=this.height||512,c=l/256*5,f=this.frequencyMin,u=(this.frequencyMax-f)/c,p=this.labelsEl.getContext("2d"),d=window.devicePixelRatio;if(this.labelsEl.height=this.height*o*d,this.labelsEl.width=55*d,p.scale(d,d),p)for(let h=0;h<o;h++){let o;for(p.fillStyle=e,p.fillRect(0,h*l,55,(1+h)*l),p.fill(),o=0;o<=c;o++){p.textAlign=n,p.textBaseline="middle";const e=f+u*o,c=this.freqType(e),d=this.unitType(e),w=16;let v;v=0==o?(1+h)*l+o-10:(1+h)*l-50*o+2,p.fillStyle=r,p.font=s+" "+i,p.fillText(d,w+24,v),p.fillStyle=a,p.font=t+" "+i,p.fillText(c,w,v)}}}resample(e){const t=this.width,s=[],i=1/e.length,a=1/t;let r;for(r=0;r<t;r++){const t=new Array(e[0].length);let n;for(n=0;n<e.length;n++){const s=n*i,h=s+i,o=r*a,l=o+a,c=h<=o||l<=s?0:Math.min(Math.max(h,o),Math.max(l,s))-Math.max(Math.min(h,o),Math.min(l,s));let f;if(c>0)for(f=0;f<e[0].length;f++)null==t[f]&&(t[f]=0),t[f]+=c/a*e[n][f]}const h=new Uint8Array(e[0].length);let o;for(o=0;o<e[0].length;o++)h[o]=t[o];s.push(h)}return s}}return i}));
